// Complete Buildstate FM MVP Schema
// This extends the previous schema with all remaining modules

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

<<<<<<< HEAD
model User {
  id                      String                  @id @default(cuid())
  email                   String                  @unique
  passwordHash            String
  firstName               String
  lastName                String
  phone                   String?
  role                    Role
  isActive                Boolean                 @default(true)
  lastLoginAt             DateTime?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  orgId                   String?
  company                 String?
  subscriptionPlan        SubscriptionPlan        @default(FREE_TRIAL)
  subscriptionStatus      SubscriptionStatus      @default(TRIAL)
  trialEndDate            DateTime?
  emailVerified           Boolean                 @default(false)
  assignedInspections     Inspection[]            @relation("AssignedTechnician")
  completedInspections    Inspection[]            @relation("CompletedBy")
  rejectedInspections     Inspection[]            @relation("RejectedInspections")
  approvedInspections     Inspection[]            @relation("ApprovedInspections")
  recurringInspections    RecurringInspection[]   @relation("RecurringInspectionAssignee")
  inspectionAuditLogs     InspectionAuditLog[]
  inspectionReminders     InspectionReminder[]
  uploadedAttachments     InspectionAttachment[] @relation("InspectionAttachmentUploadedBy")
  uploadedInspectionPhotos InspectionPhoto[]      @relation("InspectionPhotoUploadedBy")
  sentInvites             Invite[]                @relation("InvitedBy")
  receivedInvite          Invite?                 @relation("InvitedUser")
  assignedJobs            Job[]                   @relation("AssignedTechnician")
  createdJobs             Job[]                   @relation("CreatedJobs")
  jobComments             JobComment[]
  notifications           Notification[]
  OwnerProfile            OwnerProfile?
  managedProperties       Property[]              @relation("PropertyManager")
  PropertyManagerProfile  PropertyManagerProfile?
  ownedProperties         PropertyOwner[]
  approvedRecommendations Recommendation[]        @relation("ApprovedBy")
  createdRecommendations  Recommendation[]        @relation("CreatedBy")
  requestedServiceRequests ServiceRequest[]       @relation("RequestedBy")
  approvedServiceRequests  ServiceRequest[]       @relation("ApprovedRequests")
  rejectedServiceRequests  ServiceRequest[]       @relation("RejectedRequests")
  reviewedServiceRequests  ServiceRequest[]       @relation("ReviewedRequests")
  subscriptions           Subscription[]
  TechnicianProfile       TechnicianProfile?
  TenantProfile           TenantProfile?
  tenantUnits             UnitTenant[]
  unitOwners              UnitOwner[]             @relation("UnitOwners")
  reportRequests          ReportRequest[]         @relation("ReportRequestsCreated")
  passwordResets          PasswordReset[]
  emailVerificationTokens EmailVerificationToken[] @relation("EmailVerificationTokens")
  auditLogs               AuditLog[]
  Org                     Org?                    @relation(fields: [orgId], references: [id])
  blogPosts               BlogPost[]
  uploadedPropertyDocuments PropertyDocument[]  @relation("PropertyDocumentUploader")
  propertyNotes           PropertyNote[]         @relation("PropertyNoteAuthor")
  jobTemplates            JobTemplate[]          @relation("JobTemplateManager")
  jobAuditLogs            JobAuditLog[]          @relation("JobAuditUser")
  notificationPreferences NotificationPreference? @relation("NotificationPreferences")

  @@index([email])
  @@index([role])
  @@index([lastLoginAt])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  selector  String   @unique
  verifier  String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([selector])
}

model EmailVerificationToken {
  id             String   @id @default(cuid())
  userId         String
  selector       String   @unique
  hashedVerifier String
  expiresAt      DateTime
  used           Boolean  @default(false)
  createdAt      DateTime @default(now())
  user           User     @relation("EmailVerificationTokens", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([selector])
}

model Invite {
  id            String       @id @default(cuid())
  email         String
  role          Role
  token         String       @unique
  status        InviteStatus @default(PENDING)
  expiresAt     DateTime
  createdAt     DateTime     @default(now())
  invitedById   String
  invitedUserId String?      @unique
  propertyId    String?
  unitId        String?
  invitedBy     User         @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  invitedUser   User?        @relation("InvitedUser", fields: [invitedUserId], references: [id])
  property      Property?    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit          Unit?        @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([status])
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String
  planId                 String
  planName               String
  status                 SubscriptionStatus @default(TRIAL)
  stripeCustomerId       String?            @unique
  stripeSubscriptionId   String?            @unique
  stripeCurrentPeriodEnd DateTime?
  trialStartDate         DateTime           @default(now())
  trialEndDate           DateTime?
  startDate              DateTime           @default(now())
  endDate                DateTime?
  cancelledAt            DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model StripeWebhookEvent {
  id           String   @id @default(cuid())
  eventId      String   @unique
  eventType    String
  processed    Boolean  @default(false)
  processedAt  DateTime?
  createdAt    DateTime @default(now())
  data         Json?

  @@index([eventId])
  @@index([processed])
  @@index([createdAt])
}

model Property {
  id              String            @id @default(cuid())
  name            String
  address         String
  city            String
  state           String?
  zipCode         String?
  country         String            @default("USA")
  propertyType    String
  yearBuilt       Int?
  totalUnits      Int               @default(0)
  totalArea       Float?
  status          PropertyStatus    @default(ACTIVE)
  description     String?
  imageUrl        String?

  // Enhanced property details
  lotSize              Float?
  buildingSize         Float?
  numberOfFloors       Int?
  constructionType     String?
  heatingSystem        String?
  coolingSystem        String?
  amenities            Json?

  // Financial information
  purchasePrice        Float?
  purchaseDate         DateTime?
  currentMarketValue   Float?
  annualPropertyTax    Float?
  annualInsurance      Float?
  monthlyHOA           Float?

  propertyImages        PropertyImage[]
  propertyDocuments     PropertyDocument[]
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  managerId             String
  inspections           Inspection[]
  invites               Invite[]
  jobs                  Job[]
  plans                 MaintenancePlan[]
  manager               User              @relation("PropertyManager", fields: [managerId], references: [id], onDelete: Cascade)
  owners                PropertyOwner[]
  reportRequests        ReportRequest[]
  serviceRequests       ServiceRequest[]
  units                 Unit[]
  propertyNotes         PropertyNote[]
  inspectionTemplates   InspectionTemplate[]
  recurringInspections  RecurringInspection[]

  @@index([managerId])
  @@index([status])
  @@index([city, state])
}

model PropertyImage {
  id           String                 @id @default(cuid())
  propertyId   String
  imageUrl     String
  caption      String?
  category     PropertyImageCategory  @default(OTHER)
  isPrimary    Boolean                @default(false)
  displayOrder Int                    @default(0)
  uploadedById String?

  // Malware scanning
  scanStatus   FileScanStatus         @default(PENDING)
  scannedAt    DateTime?
  scanResult   Json?                  // Stores scan details, threats found, etc.

  // EXIF metadata tracking
  exifStripped Boolean                @default(false)
  exifData     Json?                  // Original EXIF data (if preserved)
  preserveExif Boolean                @default(false)

  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([displayOrder])
  @@index([category])
  @@index([scanStatus])
}

model PropertyDocument {
  id          String                      @id @default(cuid())
  propertyId  String
  unitId      String?                     // Optional: if null, belongs to property
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  category    PropertyDocumentCategory
  description String?
  accessLevel PropertyDocumentAccessLevel
  uploaderId  String

  // Malware scanning
  scanStatus   FileScanStatus             @default(PENDING)
  scannedAt    DateTime?
  scanResult   Json?

  uploadedAt  DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit     Unit?    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  uploader User     @relation("PropertyDocumentUploader", fields: [uploaderId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([unitId])
  @@index([uploaderId])
  @@index([category])
  @@index([accessLevel])
  @@index([scanStatus])
}

model PropertyNote {
  id          String   @id @default(cuid())
  propertyId  String
  authorId    String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  author   User     @relation("PropertyNoteAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([authorId])
}

model UnitImage {
  id           String   @id @default(cuid())
  unitId       String
  imageUrl     String
  caption      String?
  isPrimary    Boolean  @default(false)
  displayOrder Int      @default(0)
  uploadedById String?

  // Malware scanning
  scanStatus   FileScanStatus @default(PENDING)
  scannedAt    DateTime?
  scanResult   Json?

  // EXIF metadata tracking
  exifStripped Boolean   @default(false)
  exifData     Json?
  preserveExif Boolean   @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([displayOrder])
  @@index([scanStatus])
}

model PropertyOwner {
  id                  String    @id @default(cuid())
  propertyId          String
  ownerId             String
  ownershipPercentage Float     @default(100.0)
  startDate           DateTime  @default(now())
  endDate             DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  owner               User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  property            Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, ownerId])
  @@index([propertyId])
  @@index([ownerId])
}

model Unit {
  id                  String             @id @default(cuid())
  unitNumber          String
  propertyId          String
  floor               Int?
  bedrooms            Int?
  bathrooms           Float?
  area                Float?
  rentAmount          Float?
  status              UnitStatus         @default(AVAILABLE)
  description         String?
  imageUrl            String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  inspections         Inspection[]
  invites             Invite[]
  jobs                Job[]
  reportRequests      ReportRequest[]
  serviceRequests     ServiceRequest[]
  property            Property           @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenants             UnitTenant[]
  owners              UnitOwner[]
  unitImages          UnitImage[]
  documents           PropertyDocument[]
  recurringInspections RecurringInspection[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@index([status])
}

model UnitTenant {
  id            String   @id @default(cuid())
  unitId        String
  tenantId      String
  leaseStart    DateTime
  leaseEnd      DateTime
  rentAmount    Float
  depositAmount Float?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        User     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit          Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([tenantId])
  @@index([isActive])
}

model UnitOwner {
  id                  String    @id @default(cuid())
  unitId              String
  ownerId             String
  ownershipPercentage Float     @default(100.0)
  startDate           DateTime  @default(now())
  endDate             DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  owner               User      @relation("UnitOwners", fields: [ownerId], references: [id], onDelete: Cascade)
  unit                Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, ownerId])
  @@index([unitId])
  @@index([ownerId])
}

model Inspection {
  id                  String            @id @default(cuid())
  title               String
  type                InspectionType
  scheduledDate       DateTime
  completedDate       DateTime?
  propertyId          String
  unitId              String?
  assignedToId        String?
  completedById       String?
  status              InspectionStatus  @default(SCHEDULED)
  notes               String?
  findings            String?
  tenantSignature     String?
  tags                String[]          @default([])
  photos              String[]          @default([])

  // Approval workflow fields
  rejectionReason     String?
  rejectedById        String?
  rejectedAt          DateTime?
  approvedById        String?
  approvedAt          DateTime?

  // Template support
  templateId          String?

  // Recurring inspection support
  recurringInspectionId String?

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  assignedTo          User?             @relation("AssignedTechnician", fields: [assignedToId], references: [id])
  completedBy         User?             @relation("CompletedBy", fields: [completedById], references: [id])
  rejectedBy          User?             @relation("RejectedInspections", fields: [rejectedById], references: [id])
  approvedBy          User?             @relation("ApprovedInspections", fields: [approvedById], references: [id])
  property            Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit                Unit?             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  template            InspectionTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  recurringInspection RecurringInspection? @relation(fields: [recurringInspectionId], references: [id], onDelete: SetNull)
  attachments         InspectionAttachment[]
  auditLogs           InspectionAuditLog[]
  reminders           InspectionReminder[]
  jobs                Job[]
  report              Report?
  rooms               InspectionRoom[]
  inspectionIssues    InspectionIssue[]
  inspectionPhotos    InspectionPhoto[]

  @@index([propertyId])
  @@index([unitId])
  @@index([assignedToId])
  @@index([rejectedById])
  @@index([approvedById])
  @@index([templateId])
  @@index([recurringInspectionId])
  @@index([status])
  @@index([scheduledDate])
  @@index([completedDate])
}

model Job {
  id                String           @id @default(cuid())
  title             String
  description       String
  priority          JobPriority      @default(MEDIUM)
  status            JobStatus        @default(OPEN)
  propertyId        String?
  unitId            String?
  assignedToId      String?
  createdById       String
  serviceRequestId  String?
  maintenancePlanId String?
  inspectionId      String?
  scheduledDate     DateTime?
  startedAt         DateTime?
  completedDate     DateTime?
  estimatedCost     Float?
  actualCost        Float?
  evidence          Json?
  notes             String?
  technicianNotes   String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  createdBy         User             @relation("CreatedJobs", fields: [createdById], references: [id])
  assignedTo        User?            @relation("AssignedTechnician", fields: [assignedToId], references: [id])
  Inspection        Inspection?      @relation(fields: [inspectionId], references: [id])
  maintenancePlan   MaintenancePlan? @relation(fields: [maintenancePlanId], references: [id])
  property          Property?        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  serviceRequest    ServiceRequest?  @relation(fields: [serviceRequestId], references: [id])
  unit              Unit?            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  comments          JobComment[]

  @@index([propertyId])
  @@index([unitId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([status])
  @@index([priority])
  @@index([scheduledDate])
  @@index([assignedToId, status])
  @@index([inspectionId])
}

model JobTemplate {
  id              String      @id @default(cuid())
  name            String
  description     String
  category        String?
  priority        JobPriority @default(MEDIUM)
  estimatedCost   Float?
  estimatedHours  Float?
  instructions    String?
  requiredSkills  String[]    @default([])
  managerId       String
  isActive        Boolean     @default(true)
  usageCount      Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  manager         User        @relation("JobTemplateManager", fields: [managerId], references: [id], onDelete: Cascade)

  @@index([managerId])
  @@index([isActive])
  @@index([category])
}

model JobAuditLog {
  id          String   @id @default(cuid())
  jobId       String
  userId      String
  action      String
  field       String?
  oldValue    String?
  newValue    String?
  description String?
  createdAt   DateTime @default(now())

  user        User     @relation("JobAuditUser", fields: [userId], references: [id])

  @@index([jobId])
  @@index([userId])
  @@index([createdAt])
}

model NotificationPreference {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  emailEnabled            Boolean  @default(true)
  pushEnabled             Boolean  @default(true)
  jobAssigned             Boolean  @default(true)
  jobStatusChanged        Boolean  @default(true)
  jobCompleted            Boolean  @default(true)
  inspectionScheduled     Boolean  @default(true)
  inspectionCompleted     Boolean  @default(true)
  serviceRequestCreated   Boolean  @default(true)
  serviceRequestApproved  Boolean  @default(true)
  paymentFailed           Boolean  @default(true)
  paymentSucceeded        Boolean  @default(true)
  trialExpiring           Boolean  @default(true)
  emailDigestFrequency    String   @default("DAILY") // NEVER, DAILY, WEEKLY
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation("NotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MaintenancePlan {
  id                String    @id @default(cuid())
  name              String
  description       String?
  propertyId        String
  frequency         String
  nextDueDate       DateTime
  lastCompletedDate DateTime?
  autoCreateJobs    Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  jobs              Job[]
  property          Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([isActive])
  @@index([nextDueDate])
}

model ServiceRequest {
  id                     String                 @id @default(cuid())
  title                  String
  description            String
  category               ServiceRequestCategory
  priority               JobPriority            @default(MEDIUM)
  status                 ServiceRequestStatus   @default(SUBMITTED)
  propertyId             String
  unitId                 String?
  requestedById          String
  photos                 String[]               @default([])
  reviewNotes            String?
  reviewedAt             DateTime?

  // New fields for budget and approval workflow
  ownerEstimatedBudget   Float?
  managerEstimatedCost   Float?
  approvedBudget         Float?
  costBreakdownNotes     String?

  approvedById           String?
  approvedAt             DateTime?
  rejectedById           String?
  rejectedAt             DateTime?
  rejectionReason        String?

  lastReviewedById       String?
  lastReviewedAt         DateTime?

  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt

  jobs                   Job[]
  property               Property               @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  requestedBy            User                   @relation("RequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  approvedBy             User?                  @relation("ApprovedRequests", fields: [approvedById], references: [id])
  rejectedBy             User?                  @relation("RejectedRequests", fields: [rejectedById], references: [id])
  lastReviewedBy         User?                  @relation("ReviewedRequests", fields: [lastReviewedById], references: [id])
  unit                   Unit?                  @relation(fields: [unitId], references: [id])

  @@index([propertyId])
  @@index([unitId])
  @@index([requestedById])
  @@index([approvedById])
  @@index([rejectedById])
  @@index([lastReviewedById])
  @@index([status])
  @@index([category])
}

model Report {
  id              String           @id @default(cuid())
  title           String
  inspectionId    String           @unique
  summary         String
  findings        String
  pdfUrl          String?
  data            Json?
  generatedDate   DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  recommendations Recommendation[]
  inspection      Inspection       @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([generatedDate])
}

model ReportRequest {
  id              String   @id @default(cuid())
  reportType      String
  parameters      Json?
  propertyId      String
  unitId          String?
  requestedById   String
  status          String   @default("PENDING")
  fileUrl         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit            Unit?    @relation(fields: [unitId], references: [id])
  requestedBy     User     @relation("ReportRequestsCreated", fields: [requestedById], references: [id])
  
  @@index([propertyId])
  @@index([unitId])
  @@index([requestedById])
  @@index([status])
}

model Recommendation {
  id              String               @id @default(cuid())
  title           String
  description     String
  reportId        String
  estimatedCost   Float?
  priority        JobPriority          @default(MEDIUM)
  status          RecommendationStatus @default(DRAFT)
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  implementedAt   DateTime?
  rejectionReason String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  approvedBy      User?                @relation("ApprovedBy", fields: [approvedById], references: [id])
  createdBy       User                 @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  report          Report               @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([status])
  @@index([createdById])
}

model Notification {
  id         String           @id @default(cuid())
  userId     String
  type       NotificationType
  title      String
  message    String
  isRead     Boolean          @default(false)
  readAt     DateTime?
  entityType String?
  entityId   String?
  createdAt  DateTime         @default(now())
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model InspectionAttachment {
  id            String      @id @default(cuid())
  inspectionId  String
  name          String      @map("fileName")
  mimeType      String      @map("fileType")
  url           String      @map("fileUrl")
  size          Int?
  annotations   Json?
  uploadedById  String?

  // Malware scanning
  scanStatus    FileScanStatus @default(PENDING)
  scannedAt     DateTime?
  scanResult    Json?

  createdAt     DateTime    @default(now()) @map("uploadedAt")
  inspection    Inspection  @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  uploadedBy    User?       @relation("InspectionAttachmentUploadedBy", fields: [uploadedById], references: [id])

  @@index([inspectionId])
  @@index([scanStatus])
}

model InspectionAuditLog {
  id           String     @id @default(cuid())
  action       String
  changes      Json?
  createdAt    DateTime   @default(now()) @map("timestamp")
  inspectionId String
  userId       String?
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  user         User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([createdAt])
  @@index([userId])
}

model InspectionReminder {
  id           String     @id @default(cuid())
  inspectionId String
  remindAt     DateTime   @map("reminderDate")
  sentAt       DateTime?
  channel      String
  recipients   String[]   @default([])
  metadata     Json?
  createdById  String     @map("userId")
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  createdBy    User       @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([remindAt])
  @@index([createdById])
}

model InspectionRoom {
  id              String                    @id @default(cuid())
  inspectionId    String
  name            String
  roomType        RoomType?
  notes           String?
  order           Int                       @default(0)
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  inspection      Inspection                @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  checklistItems  InspectionChecklistItem[]
  issues          InspectionIssue[]
  photos          InspectionPhoto[]

  @@index([inspectionId])
}

model InspectionChecklistItem {
  id          String               @id @default(cuid())
  roomId      String
  description String
  status      ChecklistItemStatus  @default(PENDING)
  notes       String?
  order       Int                  @default(0)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  room        InspectionRoom       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  issues      InspectionIssue[]

  @@index([roomId])
}

model InspectionIssue {
  id              String                   @id @default(cuid())
  inspectionId    String
  roomId          String?
  checklistItemId String?
  title           String
  description     String?
  severity        IssueSeverity            @default(MEDIUM)
  status          IssueStatus              @default(OPEN)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  inspection      Inspection               @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  room            InspectionRoom?          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  checklistItem   InspectionChecklistItem? @relation(fields: [checklistItemId], references: [id], onDelete: SetNull)
  photos          InspectionPhoto[]

  @@index([inspectionId])
  @@index([roomId])
  @@index([checklistItemId])
}

model InspectionPhoto {
  id           String           @id @default(cuid())
  inspectionId String
  roomId       String?
  issueId      String?
  url          String
  caption      String?
  order        Int              @default(0)
  uploadedById String?

  // Malware scanning
  scanStatus   FileScanStatus   @default(PENDING)
  scannedAt    DateTime?
  scanResult   Json?

  // EXIF metadata tracking
  exifStripped Boolean          @default(false)
  exifData     Json?
  preserveExif Boolean          @default(false)

  createdAt    DateTime         @default(now())
  inspection   Inspection       @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  room         InspectionRoom?  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  issue        InspectionIssue? @relation(fields: [issueId], references: [id], onDelete: Cascade)
  uploadedBy   User?            @relation("InspectionPhotoUploadedBy", fields: [uploadedById], references: [id])

  @@index([inspectionId])
  @@index([roomId])
  @@index([issueId])
  @@index([scanStatus])
}

model InspectionTemplate {
  id                  String                            @id @default(cuid())
  name                String
  description         String?
  type                InspectionType
  isDefault           Boolean                           @default(false)
  isActive            Boolean                           @default(true)
  createdById         String
  propertyId          String?                           // Optional: template specific to a property
  createdAt           DateTime                          @default(now())
  updatedAt           DateTime                          @updatedAt
  property            Property?                         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  rooms               InspectionTemplateRoom[]
  inspections         Inspection[]
  recurringInspections RecurringInspection[]

  @@index([type])
  @@index([propertyId])
  @@index([isActive])
}

model InspectionTemplateRoom {
  id              String                            @id @default(cuid())
  templateId      String
  name            String
  roomType        RoomType?
  order           Int                               @default(0)
  createdAt       DateTime                          @default(now())
  updatedAt       DateTime                          @updatedAt
  template        InspectionTemplate                @relation(fields: [templateId], references: [id], onDelete: Cascade)
  checklistItems  InspectionTemplateChecklistItem[]

  @@index([templateId])
}

model InspectionTemplateChecklistItem {
  id          String                  @id @default(cuid())
  roomId      String
  description String
  order       Int                     @default(0)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  room        InspectionTemplateRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

model RecurringInspection {
  id              String              @id @default(cuid())
  title           String
  type            InspectionType
  propertyId      String
  unitId          String?
  assignedToId    String?

  // Recurrence configuration
  frequency       RecurrenceFrequency
  interval        Int                 @default(1)  // e.g., every 1 month, every 2 weeks
  dayOfMonth      Int?                             // For monthly: which day (1-31)
  dayOfWeek       Int?                             // For weekly: which day (0=Sunday, 6=Saturday)
  startDate       DateTime
  endDate         DateTime?                        // Optional end date
  nextDueDate     DateTime
  lastGeneratedDate DateTime?

  isActive        Boolean             @default(true)
  templateId      String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  property        Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit            Unit?               @relation(fields: [unitId], references: [id], onDelete: Cascade)
  assignedTo      User?               @relation("RecurringInspectionAssignee", fields: [assignedToId], references: [id])
  template        InspectionTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  inspections     Inspection[]

  @@index([propertyId])
  @@index([unitId])
  @@index([assignedToId])
  @@index([templateId])
  @@index([nextDueDate])
  @@index([isActive])
}

model Org {
  id        String   @id
  name      String
  createdAt DateTime @default(now())
  User      User[]
}

model OwnerProfile {
  id     String @id
  userId String @unique
  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PropertyManagerProfile {
  id                String   @id
  userId            String   @unique
  managedProperties Json?
  permissions       Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TechnicianProfile {
  id     String @id
  userId String @unique
  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TenantProfile {
  id     String @id
  userId String @unique
  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

=======
>>>>>>> fce809a (12)
enum Role {
  PROPERTY_MANAGER
  OWNER
  TENANT
  TECHNICIAN
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PENDING
  SUSPENDED
  CANCELLED
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  UNDER_MAINTENANCE
}

enum UnitStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  VACANT
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InspectionType {
  ROUTINE
  MOVE_IN
  MOVE_OUT
  EMERGENCY
  COMPLIANCE
}

enum JobStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum JobPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ServiceRequestStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  CONVERTED_TO_JOB
  REJECTED
  COMPLETED
}

enum ServiceRequestCategory {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  LANDSCAPING
  GENERAL
  OTHER
}

enum RecommendationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  IMPLEMENTED
}

enum NotificationType {
  INSPECTION_SCHEDULED
  INSPECTION_REMINDER
  JOB_ASSIGNED
  JOB_COMPLETED
  SERVICE_REQUEST_UPDATE
  SUBSCRIPTION_EXPIRING
  PAYMENT_DUE
  SYSTEM
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  role          Role
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships by role
  managedProperties   Property[]       @relation("PropertyManager")
  subscriptions       Subscription[]
  ownedProperties     PropertyOwner[]
  tenantUnits         UnitTenant[]
  
  // Work assignments
  assignedInspections Inspection[]     @relation("AssignedTechnician")
  completedInspections Inspection[]    @relation("CompletedBy")
  assignedJobs        Job[]            @relation("AssignedTechnician")
  
  // Communications
  sentInvites         Invite[]         @relation("InvitedBy")
  receivedInvite      Invite?          @relation("InvitedUser")
  notifications       Notification[]
  serviceRequests     ServiceRequest[]
  
  // Activity
  createdRecommendations Recommendation[] @relation("CreatedBy")
  approvedRecommendations Recommendation[] @relation("ApprovedBy")

  @@index([email])
  @@index([role])
}

model Invite {
  id            String       @id @default(cuid())
  email         String
  role          Role
  token         String       @unique
  status        InviteStatus @default(PENDING)
  expiresAt     DateTime
  createdAt     DateTime     @default(now())
  
  invitedById   String
  invitedBy     User         @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  
  invitedUserId String?      @unique
  invitedUser   User?        @relation("InvitedUser", fields: [invitedUserId], references: [id])
  
  propertyId    String?
  property      Property?    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  unitId        String?
  unit          Unit?        @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([status])
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

model Subscription {
  id                String             @id @default(cuid())
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planId            String
  planName          String
  status            SubscriptionStatus @default(TRIAL)
  
  // Stripe data
  stripeCustomerId      String?    @unique
  stripeSubscriptionId  String?    @unique
  stripeCurrentPeriodEnd DateTime?
  
  // Trial
  trialStartDate    DateTime       @default(now())
  trialEndDate      DateTime?
  
  startDate         DateTime       @default(now())
  endDate           DateTime?
  cancelledAt       DateTime?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([userId])
  @@index([status])
}

// ============================================
// PROPERTIES & UNITS
// ============================================

model Property {
  id              String         @id @default(cuid())
  name            String
  address         String
  city            String
  state           String?
  zipCode         String?
  country         String         @default("USA")

  propertyType    String
  yearBuilt       Int?
  totalUnits      Int            @default(0)
  totalArea       Float?

  status          PropertyStatus @default(ACTIVE)

  description     String?        @db.Text
  imageUrl        String?
  propertyImages  PropertyImage[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  managerId       String
  manager         User           @relation("PropertyManager", fields: [managerId], references: [id], onDelete: Cascade)

  units           Unit[]
  owners          PropertyOwner[]
  inspections     Inspection[]
  jobs            Job[]
  plans           MaintenancePlan[]
  serviceRequests ServiceRequest[]
  invites         Invite[]

  @@index([managerId])
  @@index([status])
  @@index([city, state])
}

model PropertyImage {
  id           String   @id @default(cuid())
  propertyId   String
  imageUrl     String
  caption      String?
  isPrimary    Boolean  @default(false)
  displayOrder Int      @default(0)
  uploadedById String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([displayOrder])
}

model PropertyOwner {
  id                  String   @id @default(cuid())
  
  propertyId          String
  property            Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  ownerId             String
  owner               User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  ownershipPercentage Float    @default(100.0)
  startDate           DateTime @default(now())
  endDate             DateTime?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([propertyId, ownerId])
  @@index([propertyId])
  @@index([ownerId])
}

model Unit {
  id              String     @id @default(cuid())
  unitNumber      String
  
  propertyId      String
  property        Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  floor           Int?
  bedrooms        Int?
  bathrooms       Float?
  area            Float?
  
  rentAmount      Float?
  status          UnitStatus @default(AVAILABLE)
  
  description     String?    @db.Text
  imageUrl        String?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  tenants         UnitTenant[]
  inspections     Inspection[]
  jobs            Job[]
  invites         Invite[]
  serviceRequests ServiceRequest[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@index([status])
}

model UnitTenant {
  id            String   @id @default(cuid())
  
  unitId        String
  unit          Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  tenantId      String
  tenant        User     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  leaseStart    DateTime
  leaseEnd      DateTime
  rentAmount    Float
  depositAmount Float?
  
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([unitId])
  @@index([tenantId])
  @@index([isActive])
}

// ============================================
// INSPECTIONS
// ============================================

model Inspection {
  id              String           @id @default(cuid())
  title           String
  type            InspectionType
  scheduledDate   DateTime
  completedDate   DateTime?
  
  propertyId      String?
  property        Property?        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  unitId          String?
  unit            Unit?            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  assignedToId    String?
  assignedTo      User?            @relation("AssignedTechnician", fields: [assignedToId], references: [id], onDelete: SetNull)
  
  completedById   String?
  completedBy     User?            @relation("CompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  
  status          InspectionStatus @default(SCHEDULED)
  notes           String?          @db.Text
  findings        String?          @db.Text
  
  // Photos as JSON array of URLs
  photos          Json?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  report          Report?

  @@index([propertyId])
  @@index([unitId])
  @@index([assignedToId])
  @@index([status])
  @@index([scheduledDate])
}

// ============================================
// JOBS
// ============================================

model Job {
  id              String      @id @default(cuid())
  title           String
  description     String      @db.Text
  priority        JobPriority @default(MEDIUM)
  status          JobStatus   @default(OPEN)
  
  propertyId      String?
  property        Property?   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  unitId          String?
  unit            Unit?       @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  assignedToId    String?
  assignedTo      User?       @relation("AssignedTechnician", fields: [assignedToId], references: [id], onDelete: SetNull)
  
  // Linked from service request
  serviceRequestId String?
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id], onDelete: SetNull)
  
  // Linked from maintenance plan
  maintenancePlanId String?
  maintenancePlan   MaintenancePlan? @relation(fields: [maintenancePlanId], references: [id], onDelete: SetNull)
  
  scheduledDate   DateTime?
  completedDate   DateTime?
  estimatedCost   Float?
  actualCost      Float?
  
  // Evidence/photos as JSON
  evidence        Json?
  notes           String?     @db.Text
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([propertyId])
  @@index([unitId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([scheduledDate])
}

// ============================================
// MAINTENANCE PLANS
// ============================================

model MaintenancePlan {
  id                String   @id @default(cuid())
  name              String
  description       String?  @db.Text
  
  propertyId        String
  property          Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  frequency         String   // daily, weekly, monthly, quarterly, annually
  nextDueDate       DateTime
  lastCompletedDate DateTime?
  
  // Auto-create jobs
  autoCreateJobs    Boolean  @default(false)
  
  isActive          Boolean  @default(true)
  
  jobs              Job[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([propertyId])
  @@index([isActive])
  @@index([nextDueDate])
}

// ============================================
// SERVICE REQUESTS
// ============================================

model ServiceRequest {
  id              String               @id @default(cuid())
  title           String
  description     String               @db.Text
  category        ServiceRequestCategory
  priority        JobPriority          @default(MEDIUM)
  status          ServiceRequestStatus @default(SUBMITTED)
  
  propertyId      String
  property        Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  unitId          String?
  unit            Unit?                @relation(fields: [unitId], references: [id], onDelete: SetNull)
  
  requestedById   String
  requestedBy     User                 @relation(fields: [requestedById], references: [id], onDelete: Cascade)
  
  // Photos as JSON array
  photos          Json?
  
  // Manager response
  reviewNotes     String?              @db.Text
  reviewedAt      DateTime?
  
  jobs            Job[]
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([propertyId])
  @@index([unitId])
  @@index([requestedById])
  @@index([status])
  @@index([category])
}

// ============================================
// REPORTS
// ============================================

model Report {
  id              String   @id @default(cuid())
  title           String
  
  inspectionId    String   @unique
  inspection      Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  summary         String   @db.Text
  findings        String   @db.Text
  
  // PDF file URL
  pdfUrl          String?
  
  // Report data as JSON
  data            Json?
  
  recommendations Recommendation[]
  
  generatedDate   DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([inspectionId])
  @@index([generatedDate])
}

// ============================================
// RECOMMENDATIONS
// ============================================

model Recommendation {
  id              String               @id @default(cuid())
  title           String
  description     String               @db.Text
  
  reportId        String
  report          Report               @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  estimatedCost   Float?
  priority        JobPriority          @default(MEDIUM)
  status          RecommendationStatus @default(DRAFT)
  
  createdById     String
  createdBy       User                 @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  
  approvedById    String?
  approvedBy      User?                @relation("ApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  
  approvedAt      DateTime?
  implementedAt   DateTime?
  
  rejectionReason String?              @db.Text
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([reportId])
  @@index([status])
  @@index([createdById])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type            NotificationType
  title           String
  message         String           @db.Text
  
  isRead          Boolean          @default(false)
  readAt          DateTime?
  
  // Link to related entity
  entityType      String?          // 'inspection', 'job', 'service_request', etc.
  entityId        String?
  
  createdAt       DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}
